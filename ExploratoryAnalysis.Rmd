---
title: "Exploratory analysis of OP006 operant data"
author: "JeremyMetha & MathildeBertheau"
date: "26/07/2019"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    number_sections: yes
    theme: yeti
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}

library(tidyverse)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library(corrplot)
library(ape)
library(caret)
library(RColorBrewer)
library(rmarkdown)
library(knitr)
library(gridExtra)
library(cowplot)
library(optimx)



arm1 <- read.csv("cleanarm1.csv")
```


# Sort out the Data and Create the Timeresponse column
```{r}

arm1 <- arm1 %>% 
  group_by(Day, Subject) %>% 
  arrange(Trial) %>% 
  mutate(Timebetween = (Time - lag(Time))*0.1) # Calculate the time between each presses (in seconds)



sortarm1 <- arrange(arm1, Subject, Day, Time) # Sort out the data 

head(sortarm1)

```

# Creation of the Variable Mean of the time needed for pressing a lever for all trials
```{r}
#head(arm1)

#sortarm1 %>% 
#  group_by(Day) %>% 
#  mutate(mean_timeb = mean(Timebetween, na.rm = TRUE)) %>% 
#  select(Subject, Day, mean_timeb)

TBD <- sortarm1 %>%
  group_by(Day, Subject) %>%
  summarise(mean_timeb = mean(Timebetween, na.rm=TRUE)) # New frame with the mean of timebetween for each day and each mouse. 

```

# Analyse on Each Mouse

## Mouse 1.1 

```{r}
M <- arm1[arm1$Subject=='1.1' ,]
summary(M)
table(M$Choice)
table(M$Reward)



ML <- subset(arm1, Subject=='1.1' & Task=='0P005_WTL')
dim(ML)
table(ML$Choice)

MR <- subset(arm1, Subject=='1.1' & Task=='0P005_WTR')
dim(MR)
table(MR$Choice)


Nb_pres <- count(M, Choice, Day)
names(Nb_pres)[1] <- "Lever"
Nb_pres$Lever[Nb_pres$Lever==-1] <- "Low_lever"
Nb_pres$Lever[Nb_pres$Lever==1] <- "High_lever"
names(Nb_pres)[2] <- "day"
Nb_pres
quickplot(x=day, y=n, data = Nb_pres, color = Lever) +
  labs(y = "Number of presses",
       x = "Day",
       title = "Number of presses for each lever per day for mouse 1.1")# Graph number of presses on each
ggsave("Number of presses for each lever per day for mouse 1.1.png", width = 11, height = 8)


HL <- filter(Nb_pres,Lever=='High_lever')
barplot(HL$n, xlab='Day', ylab='Nb_presses', col ='darkred', main='Evolution of presses on the High_Lever for mouse 1.1',xlim=c(0,12), ylim=c(0,100)) 

LL <- filter(Nb_pres,Lever=='Low_lever')
barplot(LL$n, xlab='Day', ylab='Nb_presses', col ='darkblue', main='Evolution of presses on the Low_Lever for mouse 1.1',xlim=c(0,12), ylim=c(0,100) )

dM <- filter(sortarm1,Subject=='1.1')


qplot(Trial, Timebetween, data = dM, geom='line') +
  facet_wrap(~ Day) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Trial number",
       title = "Evolution of Timebetween (Trials) Data for mouse 1.1 for the 10 days of experiment")

# Graphs showing the evolution of time between per trial for each day

ggplot(data = dM, aes(x = Trial, y = Timebetween)) +
  geom_boxplot() + 
  facet_grid(. ~ Day) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Trial number",
       title = "Evolution of Timebetween (Trials) Data for mouse 1.1 for the 10 days of experiment") +
  theme_linedraw() +
  theme(strip.text = element_text(size = rel(1)),
        panel.grid = element_blank())



M1 <- filter(TBD, Subject=='1.1')
ggplot(M1) + geom_point(aes(x = Day, y = mean_timeb))
gM1 <- ggplot(M1) + geom_line(aes(x = Day, y = mean_timeb)) + 
  labs(y = "Mean of Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween (mean) Data for mouse 1.1 for the 10 days of experiment")
gM1



```


Mouse 1.1 is a smart one. (Cf.Learning-Analysis)
On TPGS treatment.
The maximum number of trials is around 1000 (10 times 100 presses). He pressed 979 on 1000 trials. 
Among these 979 presses, 808 were the high rewarded lever and only 171 on the low lever. 
During the reversal phase (WTR), mouse 1.1 pressed 100 times the lever each 5 days. 
We can see that during the WTL session, he pressed 435/479 (90,8%) the high lever and 44/479 (9,2%) the low lever while during the reversal phase (WTR), he pressed 373/500 (74,6%) the high lever and 127/500 (25,4%) the low lever. 
The probability of success is obviously much better before the reversal. 


Graphs : 

The time of response decrease from day 2 to 5. (from 10,3s to 8s). We can see an increase of the time of response on day 6, which is the first day of reversal. Then the time of response decrease again to 8,25s. 



# Group of graph : Mice 1.1, 1.2, 2.3 and 2.4

```{r}
#plot_grid(gM1,gM2,gM3,gM4, labels=c("M1.1", "M1.2","M2.3", "M2.4"), ncol = 2, nrow = 2) 


```

# Analysing the timebetween per day and per mouse

```{r}
ggplot(TBD) + geom_point(aes(x = Day, y = mean_timeb, color = Subject))
```



```{r}

qplot(Day, mean_timeb, data = TBD) +
  facet_wrap(~ Subject) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data per days for each mouse")

```



# Separation of the two groups 

## TPGS Analyse time of response
```{r}


TBD2 <- sortarm1 %>% 
  group_by(Day, Subject) %>%
  mutate(mean_timeb = mean(Timebetween, na.rm = TRUE)) 
  

TPGS <- filter(TBD2, Treatment=='T')


TPGS2 <- TPGS %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day) %>% 
  mutate(mean_day = mean(mean_timeb, na.rm = TRUE)) %>% 
  select(mean_day, Day) %>%
  distinct

TPGS2

ggplot(TPGS2) + geom_point(aes(x = Day, y = mean_day)) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGS group - MEAN per DAY")

ggsave("EvolutionofTimeResponse_MEAN-per-DAY_TPGS.png", width = 11, height = 8)


ggplot(TPGS) + geom_point(aes(x = Day, y = mean_timeb)) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGS group")
ggsave("EvolutionofTimeResponse_TPGS-1.png", width = 11, height = 8)


qplot(Day, mean_timeb, data = TPGS) +
  facet_wrap(~ Subject) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGS group")

qplot(Day, mean_timeb, data = TPGS, color=Subject, geom='path') +  
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGS group")
ggsave("EvolutionofTimeResponseTPGS-2.png", width = 11, height = 8)


```



## 1-SORA-51 Analyse time of response

```{r}
DRUG <- filter(TBD2, Treatment=='S')

DRUG2 <- DRUG %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day) %>% 
  mutate(mean_day = mean(mean_timeb, na.rm = TRUE)) %>% 
  select(mean_day, Day) %>%
  distinct

DRUG2
summary(DRUG2$mean_day)


ggplot(DRUG2) + geom_point(aes(x = Day, y = mean_day)) +
    labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUG group  - MEAN for each DAY")

ggsave("EvolutionofTimeResponse-MEAN-per-DAY_SORA.png", width = 11, height = 8)


ggplot(DRUG) + geom_point(aes(x = Day, y = mean_timeb)) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUG group")

ggsave("EvolutionofTimeResponse-SORA-1.png", width = 11, height = 8)

qplot(Day, mean_timeb, data = DRUG) +
  facet_wrap(~ Subject) +
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUG group")


qplot(Day, mean_timeb, data = DRUG, color=Subject, geom='path') +  
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUG group")
ggsave("EvolutionofTimeResponseSORA-2.png", width = 11, height = 8)



```



# Correction of the Data : Removing aberant subjects values.

## In TPGS group 

```{r}

TPGScor <- subset(TPGS, Subject!='2.3' & Subject!='11.1')

qplot(Day, mean_timeb, data = TPGScor, color=Subject, geom='path') +  
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGS_cor group")

#TPGS[TPGS$mean_timeb>50 ,] # Identify aberrant subject ! 

summary(TPGScor$mean_timeb)

# Study the time of response between two presses 

TPGScor2 <- TPGScor %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day) %>% 
  mutate(mean_day = mean(mean_timeb, na.rm = TRUE)) %>% 
  select(mean_day, Day) %>%
  distinct

ggplot(TPGScor2) + geom_line(aes(x = Day, y = mean_day)) +
    labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the TPGScor group  - MEAN for each DAY")

ggsave("EvolutionofTimeResponse-TPGScor-per-day.png", width = 11, height = 8)

# Study levers 


Levers <- count(TPGScor, Choice)
Levers$Choice[Levers$Choice==-1] <- "Low_lever"
Levers$Choice[Levers$Choice==1] <- "High_lever"

Levers

quickplot(x=Day, y=n, data = Levers, color = Choice) +
  labs(y = "Number of presses",
       x = "Day",
       title = "Number of presses for each lever per day for TPGScor group")# Graph number of presses on each


AllSubT <- Levers %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day,Choice) %>% 
  mutate(mean_all = mean(n, na.rm = TRUE)) %>% 
  select(mean_all, Day) %>%
  distinct

quickplot(x=Day, y=mean_all, data = AllSubT, color = Choice) +
  labs(y = "Number of presses (MEAN)",
       x = "Day",
       title = "Number of presses for each lever per day for TPGScor group (MEAN ALL MICE)")# Graph number of presses on each

ggsave("EvolutionofLeverDecision-TPGScor-per-day.png", width = 11, height = 8)


```

## In the Drug group 

```{r}

DRUG[DRUG$mean_timeb>100 ,] # Identify aberrant subject ! 

DRUGcor <- subset(DRUG, Subject!='7.4' & Subject!='9.1' & Subject!='10.4'& Subject!='10.3')

qplot(Day, mean_timeb, data = DRUGcor, color=Subject, geom='path') +  
  labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUGcor group")

summary(DRUGcor$mean_timeb)

DRUGcor2 <- DRUGcor %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day) %>% 
  mutate(mean_day = mean(mean_timeb, na.rm = TRUE)) %>% 
  select(mean_day, Day) %>%
  distinct

ggplot(DRUGcor2) + geom_line(aes(x = Day, y = mean_day)) +
    labs(y = "Time needed between two presses (in seconds)",
       x = "Day",
       title = "Evolution of Timebetween Data for the DRUGcor group  - MEAN for each DAY")

ggsave("EvolutionofTimeResponse-SORAcor-per-day.png", width = 11, height = 8)


# Study levers

LeversD <- count(DRUGcor, Choice, Day)
LeversD$Choice[LeversD$Choice==-1] <- "Low_lever"
LeversD$Choice[LeversD$Choice==1] <- "High_lever"

quickplot(x=Day, y=n, data = LeversD, color = Choice) +
  labs(y = "Number of presses",
       x = "Day",
       title = "Number of presses for each lever per day for DRUGcor group")# Graph number of presses on each

AllSub <- LeversD %>% # New frame : mean of time of response for each day in the TPGS group
  group_by(Day,Choice) %>% 
  mutate(mean_all = mean(n, na.rm = TRUE)) %>% 
  select(mean_all, Day) %>%
  distinct

quickplot(x=Day, y=mean_all, data = AllSub, color = Choice) +
  labs(y = "Number of presses (MEAN)",
       x = "Day",
       title = "Number of presses for each lever per day for DRUGcor group (MEAN ALL MICE)")# Graph number of presses on each

ggsave("EvolutionofLeverDecision-SORAcor-per-day.png", width = 11, height = 8)

```


For the drug group, we can see that the mean time of response is approximately 13 seconds bewteen two presses while for the TPGS group the mean is approximately 10 seconds.

# Other remarks : 

# Perseverative model

```{r}
Cohort <- sortarm1 %>%
  mutate(C=case_when(Choice==-1 ~ 0,
                   Choice==1 ~ 1)) %>% 
  mutate(R=case_when(Reward==-1 ~ 0,
                   Reward==1 ~ 1)) 

Cohort         
```

```{r}


m1 <- Cohort %>%
  filter(Subject == 13.1)

choice = m1$C
reward = m1$R


source("simulate_player.R")
source("qlearning_model.R")
source("fit_qlearning.R")
source("eval_loglike.R")
inx = c(0.5, 1) #starting values for alpha and beta
result_qlearn = fit_qlearning(inx, choice, reward)

```
```{r}
library(ReinforcementLearning)
library(QLearning)

r <- arrange(arm1,Day,Trial, Subject)


```


